{% extends "blog/base.html" %}
{% block content %}
<article class="media content-section">
    <img class="rounded-circle article-img" src="{{ object.author.profile.image.url }}" alt="Author Image">
    <div class="media-body">
        <div class="article-metadata">
            <a class="mr-2" href="{% url 'public_profile' object.author.username %}">{{ object.author }}</a>
            <small class="text-muted">{{ object.created_at }}</small>
            {% if user.is_authenticated and user == object.author %}
            <div>
                <a href="{% url 'post-update' object.id %}" class="btn btn-outline-secondary btn-sm mt-1 mb-1">Update</a>
                <a href="{% url 'post-delete' object.id %}" class="btn btn-outline-danger btn-sm mt-1 mb-1">Delete</a>
            </div>
            {% endif %}
            
        </div>
        <p class="article-title">{{ object.content }}</p>

        <p>
                    {% if user.is_authenticated %}
                        <button 
                            class="btn btn-sm btn-outline-primary like-button" 
                            data-post-id="{{ post.pk }}"
                            aria-pressed="{% if user in post.likes.all %}true{% else %}false{% endif %}">
                            {% if user in post.likes.all %}
                                仇벒잺
                            {% else %}
                                游밼
                            {% endif %}
                            (<span class="likes-count">{{ post.likes.count }}</span>)
                        </button>
                    {% else %}
                        <small><a href="{% url 'login' %}">Fa칞a login</a> para dar like</small>
                    {% endif %}
                </p>
    </div>
</article>


<section id="comments-section">
    <div class="mt-5">

        {% if user.is_authenticated %}
            <h4 class="mt-4">Adiciona um coment치rio</h4>
            <form method="post" action="{% url 'add_comment' object.id %}">
                {% csrf_token %}
                <div class="mb-3">
                    {{ form.content}}
                </div>
                <button type="submit" class="btn btn-primary">Enviar</button>
            </form>
        {% else %}
            <p class="mt-3">칄 necess치rio <a href="{% url 'login' %}">fazer login</a> para comentar.</p>
        {% endif %}

        <h3>Coment치rios</h3>
        <div id="comments">
            {% for comment in parent_comments %}
                <div class="comment mb-3 p-3 border rounded" id="comment-{{ comment.id }}">
                    <div class="d-flex align-items-center mb-2">
                    <img src="{{ comment.author.profile.image.url }}" alt="Author Image" class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover;">
                    <a href="{% url 'public_profile' comment.author.username %}" class="text-decoration-none fw-bold">{{ comment.author.username }}</a>
                </div>

                    <p>{{ comment.content }}</p>
                    <small>{{ comment.created_at }}</small>

                <p><a href="#" class="reply-link" data-comment-id="{{ comment.id }}"><button class="btn btn-sm btn-outline-primary like-button">Responder</button></a></p>

                <!-- Formul치rio de resposta oculto dentro do coment치rio -->
                <form method="post" action="{% url 'add_comment' post.id %}" class="reply-form d-none mt-2" data-parent-id="{{ comment.id }}">
                    {% csrf_token %}
                    {{ form.content }}
                    <input type="hidden" name="parent_comment" value="{{ comment.id }}">
                    <button type="submit" class="btn btn-sm btn-primary mt-1">Enviar Resposta</button>
                </form>

                <!-- Renderiza as respostas aninhadas recursivamente -->
                {% include 'blog/comment_replies.html' with replies=comment.replies.all %}
                </div>
            {% empty %}
                <p>Seja o primeiro a comentar!</p>
            {% endfor %}



        </div>

        
    </div>


</section>
{% endblock content %}
